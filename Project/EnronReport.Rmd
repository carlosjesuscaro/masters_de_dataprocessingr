---
title: "Enron Report"
author: "Carlos Jesus Caro"
email: "carlos.jesus-caro@edu.dsti.institute"
class: "[A24] Big Data Processing with R"
date: "2025-09-14"
output: html_document
---

## Submission Details

* **Email:** `r rmarkdown::metadata$email`
* **Class:** `r rmarkdown::metadata$class`

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

## Summary

The goal of this project is to perform a comprehensive data analysis of the datasets provided in the Rdata file. This report will highlight the effective application of a range of data manipulation, cleaning, and transformation skills. These techniques are essential for preparing raw data for analysis, a process that accounts for a significant portion of the effort in any data-driven project. The successful execution of these tasks will demonstrate proficiency in creating a robust and reproducible analytical workflow.

## Analysis
### Loading thhe data and the libraries

```{r}
library(tidyverse)
library(wordcloud)
load('Enron.Rdata')
```

### Collecting the data sets as data frames
```{r}
employees <- as.data.frame(employeelist)
messages <- as.data.frame(message)
recipients <- as.data.frame(recipientinfo)
```

### Data inspection

Identification of the variables within each data set
```{r}
employees_cols <- paste(colnames(employees), collapse = ", ")
sprintf("`employees` data frame column names: %s", employees_cols)

messages_cols <- paste(colnames(messages), collapse = ", ")
sprintf("`messages` data frame column names: %s", messages_cols)

recipients_cols <- paste(colnames(recipients), collapse = ", ")
sprintf("`recipients` data frame column names: %s", recipients_cols)
```

Since every data frame has a unique ID, let's check if there are any duplicates.

First, let's define a function that returns the number of repeated values in a given data frame column.

```{r}
check_duplicates <- function(df, col_id) {
  rep <- df %>% 
    group_by({{ col_id }}) %>%
    count() %>%
    filter(n > 1) %>%
    nrow()
  return(rep)
}
```


```{r}
sprintf("Number of duplicated IDs in `employees` data frame: %d", check_duplicates(employees, eid))

sprintf("Number of duplicated IDs in `messages` data frame: %d", check_duplicates(messages, mid))

sprintf("Number of duplicated IDs in `recipients` data frame: %d", check_duplicates(recipients, rid))
```
Inspecting the field Status in Employees
```{r}
employees$status %>% unique()
```
It is clear that there are 2 values for NA, let's consolidate:
```{r}
employees <- employees %>%
  mutate(status = as.character(status)) %>%
  mutate(status = na_if(status, "N/A")) %>%
  mutate(status = replace_na(status, "NA"))

employees %>%
  select(status) %>%
  unique()
```

Keeping the data only between Jan 1st, 1999 and December 31st, 2022
```{r}
messages <- messages %>%
  filter(date >= as.Date('1999-01-01') & date <= as.Date('2002-12-31'))

sprintf("Number of messages between these years: %d", length(messages$date))
```

Adding two new features in the `messages` data frame for easier filtration: year and month
```{r}
messages <- messages %>%
  mutate(
    year = year(date),
    year_month = format(date, "%Y-%m")
  )
```

Joining the tables messages, employees and recipients as it will facilitate further analysis
```{r}
# 1. Since each employee can have many email address, let's create a look up table
employee_lookup <- employees %>%
  pivot_longer(
    cols = starts_with("Email"), 
    names_to = "email_type",     
    values_to = "email_address"
  ) %>%
  select(eid, email_address, status) %>%
  drop_na()

# 2. Adding the employee ID to the messages data frame
messages <- messages %>%
  left_join(employee_lookup, by = c("sender" = "email_address")) %>%
  rename('sender_id' = eid, 'sender_status' = status)


# 3. Adding the employee ID to the recipient data frame
recipients <- recipients %>%
  left_join(employee_lookup, by = c("rvalue" = "email_address")) %>%
  rename('recipient_id' = eid, 'recipient_status' = status)

# 4. Joining messages and recipients data frames
complete <- inner_join(messages, recipients, by='mid')
```

### Data insights

When reviewing th data, the 3 data frames (employees, messages and recipients), this report will aim to answer the the following questions:

### What is the proportion breakdown of eemployees based on status?
```{r}
total_employees <- length(employees$eid)

employees %>%
  group_by(status) %>%
  count(sort=TRUE) %>%
  rename(NumEmployees = n) %>%
  mutate(Proportion = round((NumEmployees / total_employees * 100), 2))
```


#### What is the difference in volume in messages in between the dates of October 31, 2001 and December 2, 2001 and the overall volume?

```{r}
messages %>%
  group_by(year) %>%
  count() %>%
  rename('NumMessages' = n)
```
Evidently, the year 2001 has a significant higher amount of messages compared to the other years. Diving into 2001
```{r}
count_2001 <- messages %>%
                filter(year == 2001) %>%
                group_by(year_month) %>%
                count() %>%
                rename('NumMessages' = n)

ggplot(data = count_2001, aes(x = year_month, y = NumMessages)) +
  geom_bar(stat = "identity", fill = "steelblue") +
  labs(
    title = "Number of Messages by Month in 2001",
    x = "Month",
    y = "Number of Messages"
  )
```

It becomes evident that the months of October and November 2001 had a significant number of emails than any other month in the same year.

#### How is the volume distribution among the different employee's role?


```{r}
complete_2001 <- complete %>%
  filter(year == 2001 & sender_status != "NA" & recipient_status != 'NA')

ggplot(data = complete_2001, aes(x = year_month, fill = sender_status)) +
  geom_bar() +
  labs(
    title = "Count of sender emails per Status and Year-Month",
    x = "Year and Month",
    y = "Count"
  ) +
  theme_minimal() +
  theme(axis.text.x = element_text(angle = 45, hjust = 1))
```
```{r}
sender_summary_proportion  <- complete_2001 %>%
                            group_by(year_month, sender_status) %>%
                            summarise(count = n(), .groups = 'drop') %>%
                            group_by(year_month) %>%
                            mutate(total_month = sum(count)) %>%
                            mutate(proportion = 100 * count / total_month) %>%
                            mutate(across(where(is.numeric), ~round(., 2))) %>%
                            select(-count, -total_month) %>%
                            pivot_wider(
                              names_from = year_month,
                              values_from = proportion
                            )

knitr::kable(sender_summary_proportion)
```


```{r}
ggplot(data = complete_2001, aes(x = year_month, fill = recipient_status)) +
  geom_bar() +
  labs(
    title = "Count of recipient emails per status and Year-Month",
    x = "Year and Month",
    y = "Count"
  ) +
  theme_minimal() +
  theme(axis.text.x = element_text(angle = 45, hjust = 1))
```
One of the most notorious findings besides the evident volume increase between October and November is the 

#### Did the patterns of message type (TO, CC, BCC) changed over the date range of interest?
```{r}
ggplot(data = complete_2001, aes(x = year_month, fill = rtype)) +
  geom_bar() +
  labs(
    title = "Count of recipient emails per status and Year-Month",
    x = "Year and Month",
    y = "Count"
  ) +
  theme_minimal() +
  theme(axis.text.x = element_text(angle = 45, hjust = 1))
```
```{r}
complete_2001 %>%
  group_by(year_month, rtype) %>%
  count() %>%
  rename(NumMessages = n) %>%
  pivot_wider(id_cols = year_month, names_from = rtype, values_from = NumMessages)
```

The proportion of email types (BCC, CC, TO) remained consistent through the months of October and November compared to the rest of the year.

